/*global growl: false*/
/*global escape: false*/
/*jslint continue:true*/
/*jslint regexp: true*/

var csvExportService = function () {
    'use strict';
    
    return {
        parse : function (arr, withLabels, withQuotes, separator) {
            var str, line, head, index, value, i;

            // Inicializando variáveis
            separator = separator || ',';
            arr = typeof arr !== 'object' ? JSON.parse(arr) : arr;
            str = '';
            line = '';

            ///////////////////////////////////////////////////////////////////
            // Checando se está definido  para incluir  os títulos
            ///////////////////////////////////////////////////////////////////
            if (withLabels) {
                head = arr[0];

                // Percorrendo as propriedades do objeto
                for (index in arr[0]) {
                    if (arr[0].hasOwnProperty(index)) {
                        // Descartando objetos adicionados pelo framework jQuery e angular.
                        if (index.indexOf('$') === 0) {
                            continue;
                        }

                        // Checando se está definido para para adicionar aspas aos campos
                        if (withQuotes) {
                            value = index.toString();
                            line += '"' + value.replace(/"/g, '""') + '"' + separator;
                        } else {
                            line += index + separator;
                        }
                    }
                }
                line = line.slice(0, -1);
                str += line + '\r\n';
            }

            ///////////////////////////////////////////////////////////////////
            // Percorrendo a lista de objetos
            ///////////////////////////////////////////////////////////////////
            for (i = 0; i < arr.length; i = i + 1) {
                line = '';

                for (index in arr[0]) {
                    if (arr[0].hasOwnProperty(index)) {
                        // Descartando objetos adicionados pelo framework jQuery e angular.
                        if (index.indexOf('$') === 0) {
                            continue;
                        }

                        // Checando se está definido para para adicionar aspas aos campos
                        if (withQuotes) {
                            value = arr[i][index].toString();
                            line += '"' + value.replace(/"/g, '""') + '"' + separator;
                        } else {
                            line += arr[i][index] + separator;
                        }
                    }
                }
                line = line.slice(0, -1);
                str += line + '\r\n';
            }

            return str;
        },

        msieversion : function () {
            var ua = window.navigator.userAgent, msie = ua.indexOf("MSIE ");
            // If Internet Explorer, return version number
            return (msie > 0 || !!navigator.userAgent.match(/Trident.*rv\:11\./));
        },

        JSONToCSVConverter : function (JSONData, withLabels) {
            var fileName = "Result", IEWindow, uri, link;

            // Verifica se o método recebeu um json
            if (JSONData.length === 0) {
                console.error('Invalid data');
                return;
            }

            // Verifica se o browser é o Internet Explorer
            if (this.msieversion()) {
                // Criando um dialogo para download do arquivo.
                IEWindow = window.open();
                IEWindow.document.write('sep=,\r\n' + JSONData);
                IEWindow.document.close();
                IEWindow.document.execCommand('SaveAs', true, fileName + ".csv");
                IEWindow.close();
            } else {
                // Criando um dialogo para download do arquivo;
                uri = 'data:application/csv;charset=utf-8,' + escape(JSONData);
                link = document.createElement("a");
                link.href = uri;
                link.style.cssText = "visibility:hidden";
                link.download = fileName + ".csv";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

        }
    };
};
var csvExportController = function ($scope, $csvExportService) {
    'use strict';
    
    var init, defaultSeparator = ';', fileName = 'report-' + (new Date()).getTime() + '.csv';

    // Form
    $scope.form = {};
    $scope.form.separator = defaultSeparator;
    $scope.form.withLabels = true;
    $scope.form.withQuotes = true;
    $scope.form.isVisible = false;
    $scope.form.csv = '';

    // Actions
    $scope.actions = {};
    
    $scope.actions.showDialog = function () {
        $scope.form.isVisible = true;
    }

    // Criando um dialogo para download do arquivo csv.
    $scope.actions.doDownload = function () {
        $csvExportService.JSONToCSVConverter($scope.source, fileName);
    };

    // Criando uma função de conversão de Json para csv.
    $scope.actions.toCSV = function () {
        $scope.form.csv = $csvExportService.parse($scope.source, $scope.form.withLabels, $scope.form.withQuotes, $scope.form.separator);
    };
};
var csvExportDirective = function () {
    'use strict';
    return {
        restrict : 'EA',
        replace : true,
        templateUrl: function (element, attr) { return (attr.templateUrl || '../dist/templates/csv-export-template.html'); },
        controller : 'CsvExportController',
        scope : {
            source : '='
        },
        link : function ($scope, $element, $attrs, $controller) {
            
            // Assistindo alterações no dataSource.
            $scope.$watch('source', function () {
                $scope.actions.toCSV($scope.source);
            });

            // Assistindo alterações de habilitação de labels.
            $scope.$watch('form.withLabels', function () {
                $scope.actions.toCSV($scope.source);
            });

            // Assistindo alterações de habilitação de Quotes.
            $scope.$watch('form.withQuotes', function () {
                $scope.actions.toCSV($scope.source);
            });

            // Assistindo alterações de caractere separador.
            $scope.$watch('form.separator', function () {
                $scope.actions.toCSV($scope.source);
            });

            // Criando um método de exibição do dialogo de download.
            $scope.showModal = function (isVisible) {    
                if (isVisible) {
                    $element.find('#mdl-export').modal("show");
                } else {
                    $element.find('#mdl-export').modal("hide");
                }
            };
            
            // Assistindo alterações do atributo isVisible.
            $scope.$watch('form.isVisible', function (newValue, oldValue) {
                $scope.showModal(newValue);
            });

            // Atualizando o status quando o painel modal for fechado através de uma ação de interface. (ok, cancel, etc...)
            $element.bind('hide.bs.modal', function () {
                $scope.form.isVisible = false;
                if (!$scope.$$phase && !$scope.$root.$$phase) {
                    $scope.$apply();
                }
            });
        }
    };
};
/*global angular: false*/
/*global csvExportService: false*/
/*global csvExportController: false*/
/*global csvExportDirective: false*/

if (angular) {
    
    var csvExportModule = angular.module('CsvExportModule', []);
    
    // Criando um serviço para exportação de um arquivo csv.
    csvExportModule.factory('$csvExportService', [csvExportService]);
    
    // Criando um controller para exportação de um arquivo csv.
    csvExportModule.controller('CsvExportController', ['$scope', '$csvExportService', csvExportController]);
    
    // Criando uma diretiva para exportação de um arquivo csv.
    csvExportModule.directive('csvExportDirective', [csvExportDirective]);
    
    
}